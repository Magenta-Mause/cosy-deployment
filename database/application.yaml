apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cosy-postgres
  namespace: argocd
spec:
  project: default
  source:
    chart: postgresql
    repoURL: https://charts.bitnami.com/bitnami
    targetRevision: 15.5.30 # Pin your version
    helm:
      values: |
        global:
          storageClass: "local-path"
        
        # 1. Configure the image to use the existing secret for the password
        auth:
          database: "cosydb" # The name of the DB to create
          existingSecret: "cosy-postgresql-credentials"
          secretKeys:
            userPasswordKey: "postgresql-password"
        
        primary:
          # 2. Map the username from the secret using Environment Variables
          # (Bitnami requires this trick to get a username from a secret)
          extraEnvVars:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: cosy-postgresql-credentials
                  key: postgresql-username
          
          # 3. K3s/Local-path specific: Fix volume permission issues
          volumePermissions:
            enabled: true
            
          # 4. Resources for K3s
          resources:
            requests:
              cpu: 250m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi

  destination:
    server: "https://kubernetes.default.svc"
    namespace: cosy
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
